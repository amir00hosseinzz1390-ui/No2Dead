package me.hittrade;

import org.bukkit.Bukkit;
import org.bukkit.entity.Entity;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageByEntityEvent;
import org.bukkit.plugin.Plugin;
import org.bukkit.plugin.java.JavaPlugin;

public class hittrade
extends JavaPlugin
implements Listener {
    private boolean isProcessing = false;

    public void onEnable() {
        Bukkit.getPluginManager().registerEvents((Listener)this, (Plugin)this);
    }

    @EventHandler
    public void onPlayerHit(final EntityDamageByEntityEvent e) {
        if (!(e.getEntity() instanceof Player)) {
            return;
        }
        if (!(e.getDamager() instanceof Player)) {
            return;
        }
        final Player victim = (Player)e.getEntity();
        final Player damager = (Player)e.getDamager();
        double victimHp = victim.getHealth();
        double damagerHp = damager.getHealth();
        if (victimHp <= 6.0 && damagerHp <= 6.0) {
            if (this.isProcessing) {
                e.setCancelled(true);
                Bukkit.getScheduler().runTaskLater((Plugin)this, new Runnable(){

                    @Override
                    public void run() {
                        double finalHp;
                        if (!victim.isDead() && victim.isOnline() && (finalHp = victim.getHealth()) > 0.0) {
                            victim.damage(e.getDamage(), (Entity)damager);
                        }
                    }
                }, 2L);
                return;
            }
            this.isProcessing = true;
            Bukkit.getScheduler().runTaskLater((Plugin)this, new Runnable(){

                @Override
                public void run() {
                    HitDelayFix.this.isProcessing = false;
                }
            }, 3L);
        }
    }
}

